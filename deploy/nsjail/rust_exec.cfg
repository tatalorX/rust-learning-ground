# /etc/nsjail/rust_exec.cfg
# Complete isolation profile for Rust code execution
# Qubes-inspired disposable execution environment

name: "rust_executor"

# -- Process limits --------------------------------------------------------
rlimit_as_type: INF          # Address space (Rust needs this for compilation)
rlimit_cpu_type: SOFT        # CPU time
rlimit_fsize_mb: 64          # Max output file size: 64MB
rlimit_nofile: 32            # Max open files
rlimit_nproc: 8              # Max child processes (for Rustc threads)
rlimit_stack_mb: 8

# -- No network whatsoever -------------------------------------------------
disable_clone_newnet: false   # Create new network namespace
iface_lo: false               # No loopback either

# -- New user namespace (run as nobody) ------------------------------------
clone_newuser: true
uidmap {
  inside_id: 65534   # nobody
  outside_id: 65534
  count: 1
}
gidmap {
  inside_id: 65534
  outside_id: 65534
  count: 1
}

# -- Filesystem: minimal read-only mounts ----------------------------------
mount_proc: false

mount {
  src: "/usr"
  dst: "/usr"
  is_bind: true
  rw: false
}

mount {
  src: "/lib"
  dst: "/lib"
  is_bind: true
  rw: false
}

mount {
  src: "/lib64"
  dst: "/lib64"
  is_bind: true
  rw: false
  mandatory: false
}

# Rust toolchain (read-only)
mount {
  src: "/root/.rustup/toolchains/stable-x86_64-unknown-linux-gnu"
  dst: "/rust"
  is_bind: true
  rw: false
}

# Ephemeral tmpfs for compilation -- wiped on exit
mount {
  dst: "/tmp"
  fstype: "tmpfs"
  options: "size=128m,noexec,nosuid"
  rw: true
}

mount {
  dst: "/home/user"
  fstype: "tmpfs"
  options: "size=32m"
  rw: true
}

# -- Seccomp syscall whitelist (deny everything not listed) ----------------
# SECURITY FIX: Removed all socket-related syscalls to prevent network escape (C-14)
seccomp_string: "
  POLICY rust_policy {
    ALLOW { read, write, open, openat, close, fstat, lstat, stat,
            mmap, mprotect, munmap, brk, pread64, pwrite64,
            access, execve, exit, exit_group, wait4, clone,
            fork, vfork, getpid, getppid, getuid, geteuid,
            getgid, getegid, arch_prctl, set_tid_address,
            set_robust_list, futex, sched_yield, nanosleep,
            getcwd, chdir, mkdir, unlink, rename, readlink,
            ioctl, fcntl, dup, dup2, pipe, pipe2,
            poll, select, epoll_create, epoll_ctl, epoll_wait,
            sigaltstack, rt_sigaction, rt_sigprocmask,
            rt_sigreturn, kill, tgkill, prctl, uname,
            lseek, writev, readv, prlimit64
    }
    # Explicitly deny dangerous syscalls including all networking
    DENY { ptrace, process_vm_readv, process_vm_writev,
           kexec_load, perf_event_open, bpf, userfaultfd,
           socket, bind, listen, accept, connect, sendto, recvfrom,
           socketpair, getsockname, getpeername, setsockopt, getsockopt }
  }
  USE rust_policy DEFAULT KILL
"
